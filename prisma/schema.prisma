generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Authentication & Authorization Models

enum UserRole {
  REQUESTER // Can view catalogue, create loan requests
  IH // Can view catalogue, approve loans for their IHs
  LOGS // Full access: manage items, approve all loans
  ADMIN // Super admin: manage users, configure system
}

enum IHType {
  INDIVIDUAL // Single person
  GROUP // IG/club/committee
  DEPARTMENT // School department
}

model User {
  userId     Int      @id @default(autoincrement()) @map("user_id")
  telegramId BigInt   @unique @map("telegram_id")
  username   String?  @map("username")
  firstName  String   @map("first_name")
  lastName   String?  @map("last_name")
  photoUrl   String?  @map("photo_url")
  role       UserRole @default(REQUESTER)
  nusnetId   String?  @unique @map("nusnet_id")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  ihMemberships IHMember[] // IHs this user is a member of

  // Relations for LoanRequest migration
  loanRequests LoanRequest[] @relation("RequesterLoanRequests")
  handledLoans LoanRequest[] @relation("LoggieLoanRequests")

  @@map("user")
}

model IHMember {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  ihId      String   @map("ih_id")
  isPrimary Boolean  @default(false) @map("is_primary")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [userId], onDelete: Cascade)
  ih   IH   @relation(fields: [ihId], references: [ihId], onDelete: Cascade)

  @@unique([userId, ihId])
  @@map("ih_member")
}

model IH {
  ihId        String           @id @map("ih_id")
  ihName      String           @map("ih_name")
  ihType      IHType           @default(INDIVIDUAL) @map("ih_type")
  ihPocTele   String?          @map("ih_poc_tele") // Deprecated: use IHMember instead
  members     IHMember[] // Multiple POCs via IHMember
  items       Item[]           @relation("ItemIH")
  loanDetails LoanItemDetail[] @relation("LoanItemDetailIH")

  @@map("ih")
}

model Item {
  itemId           Int              @id @default(autoincrement()) @map("item_id")
  nuscSn           String           @unique @map("nusc_sn")
  itemDesc         String           @map("item_desc")
  itemSloc         String           @map("item_sloc")
  itemIh           String           @map("item_ih")
  itemQty          Int              @map("item_qty")
  itemUom          String           @map("item_uom")
  itemPurchaseDate DateTime?        @map("item_purchase_date")
  itemRfpNumber    String?          @map("item_rfp_number")
  itemImage        String?          @map("item_image")
  itemRemarks      String?          @map("item_remarks")
  sloc             Sloc             @relation("ItemSloc", fields: [itemSloc], references: [slocId], onDelete: Cascade, onUpdate: Cascade)
  ih               IH               @relation("ItemIH", fields: [itemIh], references: [ihId], onDelete: Cascade, onUpdate: Cascade)
  loanDetails      LoanItemDetail[]

  @@map("item")
}

model LoanItemDetail {
  loanDetailId   Int         @id @default(autoincrement()) @map("loan_detail_id")
  refNo          Int         @map("ref_no")
  itemId         Int         @map("item_id")
  loanQty        Int         @map("loan_qty")
  loanStatus     String      @map("loan_status")
  itemSlocAtLoan String?     @map("item_sloc_at_loan")
  itemIhAtLoan   String?     @map("item_ih_at_loan")
  loanRequest    LoanRequest @relation(fields: [refNo], references: [refNo], onDelete: Cascade, onUpdate: Cascade)
  item           Item        @relation(fields: [itemId], references: [itemId], onDelete: Cascade, onUpdate: Cascade)
  slocAtLoan     Sloc?       @relation("LoanItemDetailSloc", fields: [itemSlocAtLoan], references: [slocId], onDelete: Cascade, onUpdate: Cascade)
  ihAtLoan       IH?         @relation("LoanItemDetailIH", fields: [itemIhAtLoan], references: [ihId], onDelete: Cascade, onUpdate: Cascade)

  @@map("loan_item_detail")
}

model LoanRequest {
  refNo         Int      @id @default(autoincrement()) @map("ref_no")
  loanDateStart DateTime @map("loan_date_start")
  loanDateEnd   DateTime @map("loan_date_end")

  // Relations to User (Migrated)
  reqId    Int  @map("req_id") // Was newReqId
  loggieId Int? @map("loggie_id") // Was newLoggieId

  organisation  String?
  eventDetails  String? @map("event_details")
  eventLocation String? @map("event_location")
  requestStatus String  @map("request_status")

  requester User  @relation("RequesterLoanRequests", fields: [reqId], references: [userId], onDelete: Cascade, onUpdate: Cascade)
  loggie    User? @relation("LoggieLoanRequests", fields: [loggieId], references: [userId], onDelete: Cascade, onUpdate: Cascade)

  loanDetails LoanItemDetail[]

  @@map("loan_request")
}

model Sloc {
  slocId      String           @id @map("sloc_id")
  slocName    String           @map("sloc_name")
  items       Item[]           @relation("ItemSloc")
  loanDetails LoanItemDetail[] @relation("LoanItemDetailSloc")

  @@map("sloc")
}
